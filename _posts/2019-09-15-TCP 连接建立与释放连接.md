---
title: "TCP 建立与释放连接"
date: 2019-09-15 15:17:00 +0800
categories: [TCP]
tags: [TCP]
---

## TCP 连接的建立

TCP 建立连接的过程叫握手，握手需要在客户端与服务器之间交换三个 TCP 报文段（简称三次握手）。

![TCP 三次握手](https://cloudli.top/assets/img/posts/tcp_establish.png)

一开始，B 的服务器进程处于 LISTEN 状态，等待客户端的连接请求。

A 的客户端进程建立 TCP 连接，向 B 发出连接请求报文段，首部中的同部位 SYN = 1，同时选择一个初始的随机序号 seq = x。这时，客户进程进入 SYN-SENT（同步已发送） 状态。

B 收到连接请求报文段后，向 A 发送确认，在确认报文段中把 SYN 和 ACK 位都设为 1，确认号 ack = x + 1，同时为自己选择一个初始序号 seq = y。这时服务器进程进入 SYN-RCVD（同步收到）状态。

A 收到 B 的确认后，还要向 B 给出确认。确认报文段的 ACK = 1，确认号 ack = y + 1，自己的序号 seq = x + 1。这时，TCP 连接已经建立，A 进入 ESTABLISHED（已建立连接）状态。

当 B 收到 A 的确认后，也进入 ESTABLISHED 状态。

> TCP 规定，SYN 报文段不能携带数据，但要**消耗掉一个序号**，ACK 报文段可以携带数据，但如果不携带数据则不消耗序号。

### 为什么需要三次握手

这主要是为了防止**已失效的连接请求报文段**突然又传到了 B，因而产生错误。

第一种正常情况：A 发出连接请求，但是因该请求丢失而未收到确认。于是 A 再重传一次连接请求。后来收到了确认，建立了连接。数据传输完成后，释放连接。A 发送了两个连接请求，其中第一个丢失，第二个到达 B，没有“已失效的连接请求报文段”。

第二种异常情况：A 发出的第一个连接请求没有丢失，而是在某些网络节点长时间滞留，以致延误到第二次建立的连接释放以后的某个时间才到达 B。本来是一个早已失效的报文段，但 B 收到后误以为是 A 又发出一次新的连接请求，于是向 A 发出确认报文段，同意建立连接。**假定不采取三次握手，那么只要 B 发出确认，新的连接就建立了**。

由于现在 A 并没有发出建立连接的请求，因此不会理睬 B 的确认，也不会向 B 发送数据，但 B 缺一直等待 A 发来数据。

采用三次握手的方式，在第二种异常的情况下，A 不会向 B 发出确认，B 收不到确认，就知道 A 并有要求建立连接。